<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - Aamoda Pickles</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">Checkout</h2>
    
    <!-- Cart Items -->
    <div class="card mb-4">
      <div class="card-header">Order Summary</div>
      <div class="card-body">
        <table class="table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Weight</th>
              <th>Qty</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="cartBody"></tbody>
        </table>
        <p>Subtotal: ₹<span id="subtotal">0.00</span></p>
        <p>Shipping: ₹<span id="shipping">0.00</span></p>
        <h5>Total: ₹<span id="total">0.00</span></h5>
      </div>
    </div>

    <!-- Customer Details Form -->
    <div class="card">
      <div class="card-header">Shipping Details</div>
      <div class="card-body">
        <form id="checkoutForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="fullName" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="fullName" required />
            </div>
            <div class="col-md-6">
              <label for="phone" class="form-label">Phone</label>
              <input type="tel" class="form-control" id="phone" required />
            </div>
            <div class="col-md-6">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" required />
            </div>
            <div class="col-md-6">
              <label for="address" class="form-label">Address</label>
              <input type="text" class="form-control" id="address" required />
            </div>
            <div class="col-md-4">
              <label for="city" class="form-label">City</label>
              <input type="text" class="form-control" id="city" required />
            </div>
            <div class="col-md-4">
              <label for="state" class="form-label">State</label>
              <input type="text" class="form-control" id="state" required />
            </div>
            <div class="col-md-4">
              <label for="zip" class="form-label">PIN Code</label>
              <input type="text" class="form-control" id="zip" required />
            </div>
            <div class="col-md-6">
              <label for="country" class="form-label">Country</label>
              <input type="text" class="form-control" id="country" value="India" required />
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-warning w-100">Pay Now</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const cartBody = document.getElementById('cartBody');
    const subtotalEl = document.getElementById('subtotal');
    const shippingEl = document.getElementById('shipping');
    const totalEl = document.getElementById('total');

    let subtotal = 0;
    let totalWeight = 0;

    cart.forEach(item => {
      const tr = document.createElement('tr');
      const totalItemPrice = item.price * item.quantity;
      subtotal += totalItemPrice;
      totalWeight += item.weight * item.quantity;

      tr.innerHTML = `
        <td>${item.name}</td>
        <td>${item.weight}g</td>
        <td>${item.quantity}</td>
        <td>₹${totalItemPrice}</td>
      `;
      cartBody.appendChild(tr);
    });

    subtotalEl.textContent = subtotal.toFixed(2);

    function calculateShippingFare(state, weightGrams) {
      const weightKg = weightGrams / 1000;
      const slabs = [
        { max: 0.5, price: 90 },
        { max: 1, price: 135 },
        { max: 1.5, price: 180 },
        { max: 2, price: 210 },
        { max: 2.5, price: 240 },
        { max: 3, price: 270 },
        { max: 3.5, price: 300 },
        { max: 4, price: 330 },
        { max: 4.5, price: 370 },
        { max: 5, price: 400 },
        { max: 5.5, price: 430 },
        { max: 6, price: 460 }
      ];

      let shipping = 0;
      for (let slab of slabs) {
        if (weightKg <= slab.max) {
          shipping = slab.price;
          break;
        }
      }

      if (weightKg > 6) {
        const extra = Math.ceil((weightKg - 6) / 0.5);
        shipping = 460 + (extra * 30);
      }

      if (subtotal >= 2000) {
        shipping = 0;
      }

      return shipping;
    }

    function updateShippingAndTotal() {
      const state = document.getElementById('state').value.trim();
      const shipping = calculateShippingFare(state, totalWeight);
      const total = subtotal + shipping;

      shippingEl.textContent = shipping.toFixed(2);
      totalEl.textContent = total.toFixed(2);
    }

    document.getElementById('state').addEventListener('input', updateShippingAndTotal);
    updateShippingAndTotal();

    document.getElementById('checkoutForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const fullName = document.getElementById('fullName').value;
      const phone = document.getElementById('phone').value;
      const email = document.getElementById('email').value;
      const address = document.getElementById('address').value;
      const city = document.getElementById('city').value;
      const state = document.getElementById('state').value;
      const zip = document.getElementById('zip').value;
      const country = document.getElementById('country').value;

      const totalAmount = parseFloat(totalEl.textContent) * 100;

      const options = {
        key: "YOUR_RAZORPAY_KEY_HERE",
        amount: totalAmount,
        currency: "INR",
        name: "Aamoda Pickles",
        description: "Order Payment",
        handler: function (response) {
          alert("Payment Successful! Razorpay ID: " + response.razorpay_payment_id);
          localStorage.removeItem('cart');
          window.location.href = "thankyou.html";
        },
        prefill: {
          name: fullName,
          email: email,
          contact: phone
        },
        notes: {
          address: `${address}, ${city}, ${state}, ${zip}, ${country}`
        },
        theme: {
          color: "#ffc107"
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    });
  </script>
</body>
</html>
