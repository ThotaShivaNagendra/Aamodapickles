<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Aamoda Pickles</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/geolib/2.0.24/geolib.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg custom-navbar">
        <div class="container ">
            <a class="navbar-brand" href="#">
                <img src="logo.png" class="logo-image" alt="Aamoda Pickles Logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="bg">Menu</span>
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav m-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="veg.html">Veg Pickles</a></li>
                    <li class="nav-item"><a class="nav-link" href="nonveg.html">Non-Veg Pickles</a></li>
                    <li class="nav-item"><a class="nav-link" href="specials.html">Specials</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                    <li class="nav-item">
                        <a class="nav-link" href="cart.html">
                            <i class="fas fa-shopping-cart"></i> Cart (<span id="cart-icon-count">0</span>)
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="header text-center py-4">
        <h1>Checkout</h1>
    </header>

    <section class="checkout-section py-5 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h3>Shipping Information</h3>
                    <form id="checkout-form">
                        <div class="mb-3">
                            <label for="fullName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="address"
                                placeholder="Street Address, Apartment, Suite, etc." required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state" required>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="zip" class="form-label">Zip Code</label>
                                <input type="text" class="form-control" id="zip" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="country" class="form-label">Country</label>
                            <input type="text" class="form-control" id="country" value="India" readonly>
                        </div>

                        <h3 class="mt-4">Order Summary</h3>
                        <div id="order-summary-items" class="mb-3">
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4>Subtotal: â‚¹<span id="order-subtotal">0</span></h4>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4>Shipping: â‚¹<span id="shipping-cost">0</span></h4>
                        </div>
                        <div class="text-end mb-4">
                            <h3>Total Amount: â‚¹<span id="order-total">0</span></h3>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg w-100">Pay Now</button>
                    </form>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 sticky-top" style="top: 20px;">
                        <h4 class="mb-3">Secure Payment</h4>
                        <p>Your payment will be processed securely using Razorpay.</p>
                        <p>Please review your order and shipping details before proceeding.</p>
                        <img src="razorpay.png" alt="Razorpay Placeholder" class="img-fluid mt-3">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="contact-section py-5 bg text-white">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-4 text-center mb-4 mb-md-0">
                    <img src="logo.png" class="img-fluid" style="max-height: 250px;" alt="Aamoda Pickles Logo">
                </div>
                <div class="col-md-8 text-center text-md-start">
                    <h2>Contact Us</h2>
                    <p>We'd love to hear from you! Connect with us through:</p>
                    <div class="d-flex flex-column flex-md-row justify-content-center justify-content-md-start gap-3">
                        <a href="https://wa.me/917731021234?text=Hi%2C%20I%27d%20like%20to%20place%20an%20order%20from%20Aamoda%20Pickles"
                            class="btn btn-success">ðŸ“ž WhatsApp</a>
                        <a href="https://www.instagram.com/aamodapickles" class="btn btn-light" target="_blank">ðŸ“¸
                            Instagram</a>
                        <a href="mailto:aamodapickles@gmail.com" class="btn btn-warning">ðŸ“§ Email Us</a>
                        <a href="tel:7731021234" class="btn btn-primary">ðŸ“± Call: 7731021234</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer bg-warning text-center py-4">
        <p>Â© 2025 Aamoda Pickles. All rights reserved.</p>
        <div class="container mt-2">
            <a href="terms.html" class="text-red mx-2">Terms & Conditions</a> |
            <a href="shipping.html" class="text-red mx-2">Shipping Policy</a> |
            <a href="contact.html" class="text-red mx-2">Contact Us</a> |
            <a href="refundpolicy.html" class="text-red mx-2">Cancel & refund Policy</a> |
            <a href="privacypolicy.html" class="text-red mx-2">Privacy Policy</a>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="products.js"></script>
    <script src="cart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            updateCartIcon();

            const orderSummaryItemsContainer = document.getElementById('order-summary-items');
            const orderSubtotalElement = document.getElementById('order-subtotal');
            const shippingCostElement = document.getElementById('shipping-cost');
            const orderTotalElement = document.getElementById('order-total');
            const checkoutForm = document.getElementById('checkout-form');
            const zipCodeField = document.getElementById('zip');
            const cart = getCart();

            const tanukuPinCode = '534211'; // Origin pincode
            const tanukuCoordinates = { latitude: 16.7561, longitude: 81.6888 }; // Coordinates for Tanuku

            // ----  Cart Empty Handling ----
            if (cart.length === 0) {
                orderSummaryItemsContainer.innerHTML =
                    '<p class="text-center">Your cart is empty. Please add items to proceed to checkout.</p>';
                checkoutForm.style.display = 'none'; // Hide the form if cart is empty
                orderSubtotalElement.textContent = '0';
                shippingCostElement.textContent = '0';
                orderTotalElement.textContent = '0';
                return; // Stop further execution if cart is empty
            }

            let subtotal = 0;
            let totalWeight = 0; // Total weight in grams

            // ----  Order Summary Population and Initial Calculations ----
            cart.forEach(item => {
                const product = getProductById(item.id);
                if (!product) {
                    console.error('Product not found in products.js for ID:', item.id);
                    return; // Skip this item if product details are missing
                }

                if (product.prices && product.prices[item.quantityKey]) {
                    const itemTotal = item.pricePerUnit * item.count; // Use pricePerUnit from cart item
                    subtotal += itemTotal;

                    if (product.weights && product.weights[item.quantityKey]) {
                        totalWeight += product.weights[item.quantityKey] * item.count;
                    } else {
                        console.warn('Weight information missing for product:', product.name);
                    }

                    // Add item summary to order summary container
                    orderSummaryItemsContainer.innerHTML += `
                        <div class="d-flex justify-content-between mb-1">
                            <div>${product.name} (${item.quantityKey}) x ${item.count}</div>
                            <div>â‚¹${itemTotal.toFixed(2)}</div>
                        </div>`;
                } else {
                    console.warn('Price or quantityKey missing for product:', product.name);
                }
            });

            orderSubtotalElement.textContent = subtotal.toFixed(2);

            // Calculate shipping cost initially with default distance = 0
            let shippingCost = 0;

            // Function to calculate distance (km) between Tanuku and destination coordinates
            function calculateDistanceKm(lat1, lon1, lat2, lon2) {
                const R = 6371; // Earth radius in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            // Function to simulate getting coordinates from pin code.
            // Since we don't have API, we simulate pin code mapping.
            function getCoordinatesFromPincode(pincode) {
                // You can expand this mapping as needed.
                const pinToCoords = {
                    '534211': { latitude: 16.7561, longitude: 81.6888 }, // Tanuku
                    '500001': { latitude: 17.3850, longitude: 78.4867 }, // Hyderabad
                    '110001': { latitude: 28.6139, longitude: 77.2090 }, // Delhi
                    '560001': { latitude: 12.9716, longitude: 77.5946 }, // Bangalore
                    '400001': { latitude: 19.0760, longitude: 72.8777 }, // Mumbai
                    // Add more mappings if needed
                };
                return pinToCoords[pincode] || null;
            }

            // Calculate shipping cost given totalWeight and distance
            function calculateShippingCost(weightGrams, distanceKm) {
                const weightKg = weightGrams / 1000;
                if (weightKg <= 0) return 0;

                // Shipping rates per kg by distance slabs:
                // <=50km: â‚¹20/kg
                // >50km and <=100km: â‚¹40/kg
                // >100km and <=200km: â‚¹60/kg
                // >200km: â‚¹80/kg
                let ratePerKg = 0;
                if (distanceKm <= 50) ratePerKg = 20;
                else if (distanceKm <= 100) ratePerKg = 40;
                else if (distanceKm <= 200) ratePerKg = 60;
                else ratePerKg = 80;

                return weightKg * ratePerKg;
            }

            // Initial shipping cost set to 0 because user hasn't entered zip yet
            shippingCostElement.textContent = shippingCost.toFixed(2);
            orderTotalElement.textContent = (subtotal + shippingCost).toFixed(2);

            // Update shipping cost when zip code field changes and is valid
            zipCodeField.addEventListener('input', () => {
                const pincode = zipCodeField.value.trim();
                if (pincode.length === 6) { // Indian pin codes are 6 digits
                    const destCoords = getCoordinatesFromPincode(pincode);
                    if (destCoords) {
                        const distKm = calculateDistanceKm(
                            tanukuCoordinates.latitude, tanukuCoordinates.longitude,
                            destCoords.latitude, destCoords.longitude);
                        shippingCost = calculateShippingCost(totalWeight, distKm);
                        shippingCostElement.textContent = shippingCost.toFixed(2);
                        orderTotalElement.textContent = (subtotal + shippingCost).toFixed(2);
                    } else {
                        shippingCostElement.textContent = "0.00";
                        orderTotalElement.textContent = subtotal.toFixed(2);
                    }
                } else {
                    shippingCostElement.textContent = "0.00";
                    orderTotalElement.textContent = subtotal.toFixed(2);
                }
            });

            // Handle form submit & payment
            checkoutForm.addEventListener('submit', function (e) {
                e.preventDefault();

                if (cart.length === 0) {
                    alert("Your cart is empty. Please add items before paying.");
                    return;
                }

                const name = document.getElementById('fullName').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const address = document.getElementById('address').value.trim();
                const city = document.getElementById('city').value.trim();
                const state = document.getElementById('state').value.trim();
                const zip = document.getElementById('zip').value.trim();
                const country = document.getElementById('country').value.trim();

                if (!name || !email || !phone || !address || !city || !state || !zip || !country) {
                    alert("Please fill all shipping information fields.");
                    return;
                }

                const amountInPaise = Math.round((subtotal + shippingCost) * 100); // Razorpay amount in paise

                // Razorpay options
                var options = {
                    key: "rzp_test_DzBj3C9GR0qaHw",
                    amount: amountInPaise,
                    currency: "INR",
                    name: "Aamoda Pickles",
                    description: "Order Payment",
                    prefill: {
                        name: name,
                        email: email,
                        contact: phone,
                    },
                    handler: function (response) {
                        alert("Payment successful. Payment ID: " + response.razorpay_payment_id);
                        localStorage.removeItem("cart");
                        window.location.href = "success.html"; // Redirect after payment success
                    },
                    modal: {
                        ondismiss: function () {
                            alert('Payment popup closed before completing the payment.');
                        }
                    }
                };

                var rzp = new Razorpay(options);

                rzp.on('payment.failed', function (response) {
                    alert("Payment failed: " + response.error.description);
                });

                rzp.open();
            });
        });
    </script>
</body>

</html>
