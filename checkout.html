<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Aamoda Pickles</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/geolib/2.0.24/geolib.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg custom-navbar">
    <div class="container ">
        <a class="navbar-brand" href="#">
            <img src="logo.png" class="logo-image" alt="Aamoda Pickles Logo">
        </a>
        <div class="d-flex align-items-center d-lg-none">
            <a class="nav-link pe-2" href="cart.html">
                <i class="fas fa-shopping-cart text-white"></i>(<span id="cart-icon-count-mobile">0</span>)
            </a>
            <button class="navbar-toggler p-0 border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fas fa-search text-white"></i>
                <span class="bg menu ms-2">Menu</span>
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav m-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="veg.html">Veg Pickles</a></li>
                <li class="nav-item"><a class="nav-link" href="nonveg.html">Non-Veg Pickles</a></li>
                <li class="nav-item"><a class="nav-link" href="specials.html">Specials</a></li>
                <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                <li class="nav-item">
                    <a class="nav-link" href="cart.html">
                        <i class="fas fa-shopping-cart"></i>Cart (<span id="cart-icon-count-desktop">0</span>)
                    </a>
                </li>
            </ul>
            <form class="d-flex ms-lg-auto" id="searchForm">
                <input class="form-control me-2" type="search" placeholder="Search products..." aria-label="Search" id="searchInput">
                <button class="btn btn-outline-success" type="submit"><i class="fas fa-search"></i></button>
                <div id="searchResults" class="position-absolute bg-white shadow rounded mt-2" style="z-index: 1000; width: calc(100% - 20px); display: none;">
                    </div>
            </form>
        </div>
    </div>
    </nav>

    <header class="header text-center py-4">
        <h1>Checkout</h1>
    </header>

    <section class="checkout-section py-5 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h3>Shipping Information</h3>
                    <form id="checkout-form">
                        <div class="mb-3">
                            <label for="fullName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="address"
                                placeholder="Street Address, Apartment, Suite, etc." required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="state" class="form-label">State</label>
                                <select class="form-select" id="state" required>
                                    <option value="" disabled selected>Select State</option>
                                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                                    <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                    <option value="Assam">Assam</option>
                                    <option value="Bihar">Bihar</option>
                                    <option value="Chhattisgarh">Chhattisgarh</option>
                                    <option value="Goa">Goa</option>
                                    <option value="Gujarat">Gujarat</option>
                                    <option value="Haryana">Haryana</option>
                                    <option value="Himachal Pradesh">Himachal Pradesh</option>
                                    <option value="Jharkhand">Jharkhand</option>
                                    <option value="Karnataka">Karnataka</option>
                                    <option value="Kerala">Kerala</option>
                                    <option value="Madhya Pradesh">Madhya Pradesh</option>
                                    <option value="Maharashtra">Maharashtra</option>
                                    <option value="Manipur">Manipur</option>
                                    <option value="Meghalaya">Meghalaya</option>
                                    <option value="Mizoram">Mizoram</option>
                                    <option value="Nagaland">Nagaland</option>
                                    <option value="Odisha">Odisha</option>
                                    <option value="Punjab">Punjab</option>
                                    <option value="Rajasthan">Rajasthan</option>
                                    <option value="Sikkim">Sikkim</option>
                                    <option value="Tamil Nadu">Tamil Nadu</option>
                                    <option value="Telangana">Telangana</option>
                                    <option value="Tripura">Tripura</option>
                                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                                    <option value="Uttarakhand">Uttarakhand</option>
                                    <option value="West Bengal">West Bengal</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="zip" class="form-label">Zip Code</label>
                                <input type="text" class="form-control" id="zip" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="country" class="form-label">Country</label>
                            <input type="text" class="form-control" id="country" value="India" readonly>
                        </div>

                        <h3 class="mt-4">Order Summary</h3>
                        <div id="order-summary-items" class="mb-3">
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4>Subtotal: ₹<span id="order-subtotal">0</span></h4>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4>Shipping: ₹<span id="shipping-cost">0</span></h4>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <p>(free Shipping on order above Rs.3000)</p>
                        </div>
                        <div class="text-end mb-4">
                            <h3>Total Amount: ₹<span id="order-total">0</span></h3>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg w-100">Pay Now</button>
                    </form>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 " style="top: 20px;">
                        <h4 class="mb-3">Secure Payment</h4>
                        <p>Your payment will be processed securely using Razorpay.</p>
                        <p>Please review your order and shipping details before proceeding.</p>
                        <img src="razorpay.png" alt="Razorpay Placeholder" class="img-fluid mt-3">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="contact-section py-5 bg text-white">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-4 text-center mb-4 mb-md-0">
                    <img src="logo.png" class="img-fluid" style="max-height: 250px;" alt="Aamoda Pickles Logo">
                </div>
                <div class="col-md-8 text-center text-md-start">
                    <h2 style="padding: 10px;">Contact Us</h2>
                    <p>We'd love to hear from you! Connect with us through:</p>
                    <div class="d-flex flex-column flex-md-row justify-content-center justify-content-md-start gap-3">
                        <a href="https://wa.me/917731021234?text=Hi%2C%20I%27d%20like%20to%20place%20an%20order%20from%20Aamoda%20Pickles"
                            class="btn btn-success"> WhatsApp</a>
                        <a href="https://www.instagram.com/aamodapickles" class="btn btn-light" target="_blank">
                            Instagram</a>
                        <a href="mailto:aamodapickles@gmail.com" class="btn btn-warning"> Email Us</a>
                        <a href="tel:7731021234" class="btn btn-primary"> Call: 7731021234</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer bg-warning text-center py-4">
        <p>© 2025 Aamoda Pickles. All rights reserved.</p>
        <div class="container mt-2">
            <a href="terms.html" class="text-red mx-2">Terms & Conditions</a> |
            <a href="shipping.html" class="text-red mx-2">Shipping Policy</a> |
            <a href="contact.html" class="text-red mx-2">Contact Us</a> |
            <a href="refundpolicy.html" class="text-red mx-2">Cancel & refund Policy</a> |
            <a href="privacypolicy.html" class="text-red mx-2">Privacy Policy</a>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="products.js"></script>
    <script src="cart.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            updateCartIcon();

            const orderSummaryItemsContainer = document.getElementById('order-summary-items');
            const orderSubtotalElement = document.getElementById('order-subtotal');
            const shippingCostElement = document.getElementById('shipping-cost');
            const orderTotalElement = document.getElementById('order-total');
            const checkoutForm = document.getElementById('checkout-form');
            const zipCodeField = document.getElementById('zip');
            const stateField = document.getElementById('state');
            const cityField = document.getElementById('city');
            const cart = getCart();

            const tanukuPinCode = '534211'; // Origin pincode (Andhra Pradesh)
            const tanukuCoordinates = { latitude: 16.7561, longitude: 81.6888 }; // Coordinates for Tanuku

            // Define shipping zones and rates (adjust these based on your actual costs)
            const shippingRates = {
                    "Andhra Pradesh": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 90 },
                        { "maxWeightKg": 1, "rate": 135 },
                        { "maxWeightKg": 1.5, "rate": 180 },
                        { "maxWeightKg": 2, "rate": 210 },
                        { "ratePerKgAbove2": 30 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Telangana": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 90 },
                        { "maxWeightKg": 1, "rate": 135 },
                        { "maxWeightKg": 1.5, "rate": 180 },
                        { "maxWeightKg": 2, "rate": 210 },
                        { "ratePerKgAbove2": 30 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Karnataka": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 120 },
                        { "maxWeightKg": 1, "rate": 175 },
                        { "maxWeightKg": 1.5, "rate": 230 },
                        { "maxWeightKg": 2, "rate": 280 },
                        { "ratePerKgAbove2": 50 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Tamil Nadu": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 120 },
                        { "maxWeightKg": 1, "rate": 175 },
                        { "maxWeightKg": 1.5, "rate": 230 },
                        { "maxWeightKg": 2, "rate": 280 },
                        { "ratePerKgAbove2": 50 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Kerala": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 120 },
                        { "maxWeightKg": 1, "rate": 175 },
                        { "maxWeightKg": 1.5, "rate": 230 },
                        { "maxWeightKg": 2, "rate": 280 },
                        { "ratePerKgAbove2": 50 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Arunachal Pradesh": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Assam": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Bihar": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Chhattisgarh": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Goa": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Gujarat": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Haryana": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Himachal Pradesh": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Jharkhand": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Madhya Pradesh": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Maharashtra": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Manipur": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Meghalaya": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Mizoram": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Nagaland": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Odisha": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Punjab": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Rajasthan": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Sikkim": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Tripura": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Uttar Pradesh": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "Uttarakhand": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    },
                    "West Bengal": {
                      "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 150 },
                        { "maxWeightKg": 1, "rate": 220 },
                        { "maxWeightKg": 1.5, "rate": 290 },
                        { "maxWeightKg": 2, "rate": 360 },
                        { "ratePerKgAbove2": 70 }
                      ],
                      "freeShippingThreshold": 3000
                    }
    
                  };

            // ----  Cart Empty Handling ----
            if (cart.length === 0) {
                orderSummaryItemsContainer.innerHTML =
                    '<p class="text-center">Your cart is empty. Please add items to proceed to checkout.</p>';
                checkoutForm.style.display = 'none'; // Hide the form if cart is empty
                orderSubtotalElement.textContent = '0';
                shippingCostElement.textContent = '0';
                orderTotalElement.textContent = '0';
                return; // Stop further execution if cart is empty
            }

            let subtotal = 0;
            let totalWeight = 0; // Total weight in grams

            // ----  Order Summary Population and Initial Calculations ----
            cart.forEach(item => {
                const product = getProductById(item.id);

                if (!product) {
                    console.error('Product not found in products.js for ID:', item.id);
                    return; // Skip this item if product details are missing
                }

                if (product.prices && product.prices[item.quantityKey]) {
                    const itemTotal = item.pricePerUnit * item.count; // Use pricePerUnit from cart item
                    subtotal += itemTotal;

                    if (product.weights && product.weights[item.quantityKey]) {
                        totalWeight += product.weights[item.quantityKey] * item.count;
                    } else {
                        console.warn('Weight information missing for product:', product.name, 'quantity:', item.quantityKey);
                    }

                    const orderItemHtml = `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <span>${product.name} (${item.quantityKey}) x ${item.count}</span>
                            <span>₹${itemTotal.toFixed(2)}</span>
                        </div>
                    `;
                    orderSummaryItemsContainer.innerHTML += orderItemHtml;
                } else {
                    console.error('Price information missing or invalid quantity key for product:', product.name, 'quantity:', item.quantityKey);
                }
            });

            orderSubtotalElement.textContent = subtotal.toFixed(2); // Display with 2 decimal places

            // ---- Shipping Calculation based on State and Weight ----
            // ---- Shipping Calculation based on State and Weight ----

            // ---- Shipping Calculation based on State and Weight ----
            function calculateShipping() {
                let shippingRate = 0;
                const totalWeightKg = totalWeight / 1000;
                const currentState = stateField.value;
                // Use selected state rates or default if not found
                const selectedStateRates = shippingRates[currentState] || shippingRates["default"] || {
                    "weightSlabs": [
                        { "maxWeightKg": 0.5, "rate": 90 },
                        { "maxWeightKg": 1, "rate": 135 },
                        { "maxWeightKg": 1, "rate": 180 },
                        { "maxWeightKg": 2, "rate": 210 },
                        { "ratePerKgAbove2": 30 }
                    ],
                    "freeShippingThreshold": 3000
                };

                const freeShippingThreshold = selectedStateRates.freeShippingThreshold;
                const weightSlabs = selectedStateRates.weightSlabs;

                if (subtotal >= freeShippingThreshold) {
                    shippingRate = 0; // Free shipping
                } else {
                    for (const slab of weightSlabs) {
                        if (slab.maxWeightKg !== undefined && totalWeightKg <= slab.maxWeightKg) {
                            shippingRate = slab.rate;
                            break;
                        } else if (slab.ratePerKgAbove2 !== undefined && totalWeightKg > 2) {
                            shippingRate = weightSlabs.find(s => s.maxWeightKg === 2)?.rate || weightSlabs[weightSlabs.length - 2]?.rate || 0; // Base rate up to 2kg
                            shippingRate += Math.ceil(totalWeightKg - 2) * slab.ratePerKgAbove2;
                            break;
                        } else if (weightSlabs.length > 0 && slab === weightSlabs[weightSlabs.length - 1] && slab.ratePerKgAbove2 === undefined) {
                            // If none of the weight slabs match and there's no ratePerKgAbove2, use the last defined rate (if any)
                            shippingRate = slab.rate || 0;
                        }
                    }
                    // Ensure a minimum shipping rate if the cart isn't empty and doesn't qualify for free shipping
                    if (cart.length > 0 && subtotal < freeShippingThreshold && shippingRate === 0) {
                        shippingRate = shippingRates["default"]?.weightSlabs[0]?.rate || 50; // Apply default minimum
                    }
                }

                // Update display
                shippingCostElement.textContent = shippingRate.toFixed(2);
                const totalAmount = subtotal + shippingRate;
                orderTotalElement.textContent = totalAmount.toFixed(2);

                return shippingRate; // Return the calculated shipping rate
            }
  
            // ----  Initial Calculations & Event Listeners for Dynamic Update ----
            // Initial calculation when the page loads
            calculateShipping();

            // Recalculate shipping and total when relevant fields change
            stateField.addEventListener('input', calculateShipping);
            zipCodeField.addEventListener('input', calculateShipping);
            cityField.addEventListener('input', calculateShipping);
            
            //search logic
             const searchInput = document.getElementById('searchInput');
            const searchResultsDiv = document.getElementById('searchResults');

                searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                searchResultsDiv.innerHTML = ''; // Clear previous suggestions
                searchResultsDiv.style.display = 'none'; // Hide the suggestion box initially

                if (searchTerm) {
                    const matchingProducts = products.filter(product =>
                        product.name.toLowerCase().startsWith(searchTerm)
                    );

                    if (matchingProducts.length > 0) {
                        searchResultsDiv.style.display = 'block';
                        const suggestionsList = document.createElement('ul');
                        suggestionsList.classList.add('list-unstyled', 'm-0', 'p-0');

                        matchingProducts.forEach(product => {
                            const listItem = document.createElement('li');
                            listItem.classList.add('p-2', 'border-bottom', 'cursor-pointer');
                            listItem.textContent = product.name;
                            listItem.addEventListener('click', () => {
                                window.location.href = `product-details.html?id=${product.id}`;
                                searchInput.value = ''; // Clear input after selection
                                searchResultsDiv.style.display = 'none'; // Hide suggestions after selection
                            });
                            suggestionsList.appendChild(listItem);
                        });
                        searchResultsDiv.appendChild(suggestionsList);
                  }
                }
            });

            // Firebase configuration (replace with your actual project config)
        const firebaseConfig = {
            apiKey: "AIzaSyANIbMcUHunk0Gjgi3xYc1-s6YENxNqG0o",
            authDomain: "aamoda-pickles.firebaseapp.com",
            projectId: "aamoda-pickles",
            storageBucket: "aamoda-pickles.firebasestorage.app",
            messagingSenderId: "1009552622686",
            appId: "1:1009552622686:web:56858d3588e38dd174a0cf",
            measurementId: "G-D1CVE3WP7N"
        };

        // Initialize Firebase if not already
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();
        // Get Firebase Functions service instance
        const functions = firebase.functions();
        // If your functions are not in 'us-central1' region, specify it:
        // const functions = firebase.functions('your-region');

        document.addEventListener('DOMContentLoaded', () => {
            const checkoutForm = document.getElementById('checkoutForm');
            const orderTotalElement = document.getElementById('orderTotal');
        function updateCheckoutTotalDisplay() {
        const cartTotal = calculateCartTotal(); // This function is from cart.js
        const shippingCost = 0; // Or call calculateShipping() if you have it
        const grandTotal = cartTotal + shippingCost;
        orderTotalElement.textContent = grandTotal.toFixed(2); // Display with 2 decimal places
    }
    // Call it once when the page loads
    updateCheckoutTotalDisplay();

    // Optional: If you have a way to change shipping or apply discounts
    // that affects the total display without form submission, call
    // updateCheckoutTotalDisplay() again when those values change
            // --- Your existing search functionality (keep this as is) ---
            const searchInput = document.getElementById('searchInput');
            const searchResultsDiv = document.getElementById('searchResults');

            if (searchInput && searchResultsDiv) {
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    searchResultsDiv.innerHTML = ''; // Clear previous results

                    if (searchTerm.length > 0) {
                        const matchingProducts = products.filter(product =>
                            product.name.toLowerCase().includes(searchTerm)
                        );

                        if (matchingProducts.length > 0) {
                            searchResultsDiv.style.display = 'block';
                            const suggestionsList = document.createElement('ul');
                            suggestionsList.classList.add('list-unstyled', 'm-0', 'p-0');

                            matchingProducts.forEach(product => {
                                const listItem = document.createElement('li');
                                listItem.classList.add('p-2', 'border-bottom', 'cursor-pointer');
                                listItem.textContent = product.name;
                                listItem.addEventListener('click', () => {
                                    window.location.href = `product-details.html?id=${product.id}`;
                                    searchInput.value = ''; // Clear input after selection
                                    searchResultsDiv.style.display = 'none'; // Hide suggestions after selection
                                });
                                suggestionsList.appendChild(listItem);
                            });
                            searchResultsDiv.appendChild(suggestionsList);
                        } else {
                            searchResultsDiv.style.display = 'none';
                        }
                    } else {
                        searchResultsDiv.style.display = 'none';
                    }
                });

                document.addEventListener('click', (event) => {
                    if (!searchInput.contains(event.target) && !searchResultsDiv.contains(event.target)) {
                        searchResultsDiv.style.display = 'none';
                    }
                });
            }

            // --- Razorpay Integration (using Firebase Cloud Functions) ---
            if (checkoutForm) { // Ensure the form element exists
                checkoutForm.addEventListener('submit', async function (e) {
                    e.preventDefault(); // Prevent the default form submission

                    // --- 1. Gather Client-Side Customer & Cart Data ---
                    const fullName = document.getElementById('fullName').value;
                    const email = document.getElementById('email').value;
                    const phone = document.getElementById('phone').value;
                    const address = document.getElementById('address').value;
                    const city = document.getElementById('city').value;
                    const state = document.getElementById('state').value;
                    const zipCode = document.getElementById('zip').value;
                    const country = document.getElementById('country').value;

                    // Assuming these functions are available from cart.js
                    const currentShippingCost = 0; // Implement calculateShipping() if needed
                    const cartItems = getCart(); // Get the current cart from cart.js
                    const totalWeight = calculateTotalWeight(); // Get total weight from cart.js

                    // Basic validation: Ensure cart is not empty
                    if (!cartItems || cartItems.length === 0) {
                        alert('Your cart is empty. Please add items before checking out.');
                        return;
                    }

                    // Optional: Show loading indicator / Disable button
                    const payNowButton = document.getElementById('payNowButton');
                    if (payNowButton) payNowButton.disabled = true;

                    try {
                        console.log("Attempting to create Razorpay Order via Cloud Function...");

                        // --- 2. Call Server-Side Cloud Function: `createRazorpayOrder` ---
                        // This sends your cart and customer details to the backend to
                        // securely create a Razorpay order and validate the amount.
                        const createOrderCallable = functions.httpsCallable('createRazorpayOrder');

                        const orderCreationResponse = await createOrderCallable({
                            cartItems: cartItems, // Send the full cart items for server-side price validation
                            customerDetails: {
                                fullName: fullName, email: email, phone: phone,
                                address: address, city: city, state: state, zipCode: zipCode, country: country,
                            },
                            shippingCost: currentShippingCost,
                            totalWeightKg: totalWeight / 1000, // Convert grams to KG for server notes
                        });

                        // Destructure the secure response from the Cloud Function
                        const { orderId: razorpayOrderId, amount: verifiedAmount, currency: verifiedCurrency } = orderCreationResponse.data;

                        console.log(`Received Razorpay Order ID from server: ${razorpayOrderId}`);

                        // --- 3. Configure and Open Razorpay Checkout Pop-up ---
                        const options = {
                            key: "rzp_live_3InjjEzd3LUWLP", // Your PUBLIC Razorpay Key ID (rzp_live_... or rzp_test_...)
                            amount: verifiedAmount,         // *** SECURE AMOUNT FROM SERVER *** (in paise)
                            currency: verifiedCurrency,     // *** CURRENCY FROM SERVER ***
                            order_id: razorpayOrderId,      // *** SECURE ORDER ID FROM SERVER ***
                            name: "Aamoda Pickles",
                            description: "Order from Aamoda Pickles",
                            image: "/logo.png", // Path to your logo image
                            handler: function (response) {
                                // This function is called by Razorpay upon successful payment in the pop-up.
                                console.log("Payment successful in Razorpay pop-up. Now verifying payment on server...");

                                // --- 4. Call Server-Side Cloud Function: `processRazorpayPayment` ---
                                // This sends Razorpay's response to your backend for secure signature verification
                                // and saving the order to Firestore.
                                const processPaymentCallable = functions.httpsCallable('processRazorpayPayment');

                                // Generate a unique internal order ID for your Firestore record
                                const internalOrderId = generateOrderId(); // This function is defined below

                                processPaymentCallable({
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_order_id: response.razorpay_order_id, // The same order ID received from createRazorpayOrder
                                    razorpay_signature: response.razorpay_signature, // Crucial for server-side verification
                                    internalOrderId: internalOrderId, // Your unique ID for this order in Firestore
                                    customerDetails: { fullName, email, phone, address, city, state, zipCode, country },
                                    cartItems: getCart(), // Send full cart items to be saved with the order
                                    shippingCost: currentShippingCost,
                                    totalAmount: parseFloat(orderTotalElement.textContent) // Client's displayed total (for record, server has already verified)
                                })
                                .then(() => {
                                    console.log("Order successfully processed and saved to Firestore via Cloud Function.");
                                    clearCart(); // Clear the cart *after* successful server-side processing
                                    // Redirect to a thank you page
                                    window.location.href = `thankyou.html?orderId=${internalOrderId}&paymentId=${response.razorpay_payment_id}`;
                                })
                                .catch((error) => {
                                    console.error("Error processing payment on server:", error);
                                    alert(`There was an issue finalizing your order after payment. Please contact support with Payment ID: ${response.razorpay_payment_id || 'N/A'}`);
                                })
                                .finally(() => {
                                    // Re-enable button
                                    if (payNowButton) payNowButton.disabled = false;
                                });
                            },
                            // Prefill customer details in Razorpay pop-up for convenience
                            prefill: {
                                name: fullName,
                                email: email,
                                contact: phone
                            },
                            // Notes visible in your Razorpay dashboard
                            notes: {
                                address: address, city: city, state: state, zip: zipCode, country: country,
                                shippingCost: currentShippingCost, totalWeightKg: totalWeight / 1000
                            },
                            theme: {
                                color: "#400607" // Your brand color
                            },
                            modal: {
                                ondismiss: function() {
                                    console.log("Razorpay payment pop-up closed by user.");
                                    alert("Payment cancelled. If you need help, feel free to contact us.");
                                }
                            }
                        };

                        const rzp = new Razorpay(options);

                        // Handle payment failures that occur within the Razorpay pop-up
                        rzp.on('payment.failed', function (response) {
                            console.error("Razorpay Payment Failed:", response.error);
                            alert(`Payment failed. Please try again or use another method.\nReason: ${response.error.description}`);
                            if (payNowButton) payNowButton.disabled = false; // Re-enable button on failure
                        });

                        rzp.open(); // Open the Razorpay checkout pop-up

                    } catch (error) {
                        console.error("Error during payment initiation or Cloud Function call:", error);
                        alert(`Failed to start payment: ${error.message || 'An unknown error occurred'}. Please try again or contact support.`);
                        if (payNowButton) payNowButton.disabled = false; // Re-enable button on any error
                    }
                });
            }
        });

        // Helper function to generate a unique ID for your Firestore orders
        function generateOrderId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substr(2, 5);
            return timestamp + '-' + random;
        }
    </script>
</body>

</html>