<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Aamoda Pickles</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/geolib/2.0.24/geolib.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg custom-navbar">
        <div class="container ">
            <a class="navbar-brand" href="#">
                <img src="logo.png" class="logo-image" alt="Aamoda Pickles Logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="bg">Menu</span>
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav m-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="veg.html">Veg Pickles</a></li>
                    <li class="nav-item"><a class="nav-link" href="nonveg.html">Non-Veg Pickles</a></li>
                    <li class="nav-item"><a class="nav-link" href="specials.html">Specials</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                    <li class="nav-item">
                        <a class="nav-link" href="cart.html">
                            <i class="fas fa-shopping-cart"></i> Cart (<span id="cart-icon-count">0</span>)
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="header text-center py-4">
        <h1>Checkout</h1>
    </header>

    <section class="checkout-section py-5 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h3>Shipping Information</h3>
                    <form id="checkout-form">
                        <div class="mb-3">
                            <label for="fullName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="address"
                                placeholder="Street Address, Apartment, Suite, etc." required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state" required>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="zip" class="form-label">Zip Code</label>
                                <input type="text" class="form-control" id="zip" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="country" class="form-label">Country</label>
                            <input type="text" class="form-control" id="country" value="India" readonly>
                        </div>

                        <h3 class="mt-4">Order Summary</h3>
                        <div id="order-summary-items" class="mb-3">
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4>Subtotal: â‚¹<span id="order-subtotal">0</span></h4>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4>Shipping: â‚¹<span id="shipping-cost">0</span></h4>
                        </div>
                        <div class="text-end mb-4">
                            <h3>Total Amount: â‚¹<span id="order-total">0</span></h3>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg w-100">Pay Now</button>
                    </form>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 sticky-top" style="top: 20px;">
                        <h4 class="mb-3">Secure Payment</h4>
                        <p>Your payment will be processed securely using Razorpay.</p>
                        <p>Please review your order and shipping details before proceeding.</p>
                        <img src="razorpay.png" alt="Razorpay Placeholder" class="img-fluid mt-3">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="contact-section py-5 bg text-white">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-4 text-center mb-4 mb-md-0">
                    <img src="logo.png" class="img-fluid" style="max-height: 250px;" alt="Aamoda Pickles Logo">
                </div>
                <div class="col-md-8 text-center text-md-start">
                    <h2>Contact Us</h2>
                    <p>We'd love to hear from you! Connect with us through:</p>
                    <div class="d-flex flex-column flex-md-row justify-content-center justify-content-md-start gap-3">
                        <a href="https://wa.me/917731021234?text=Hi%2C%20I%27d%20like%20to%20place%20an%20order%20from%20Aamoda%20Pickles"
                            class="btn btn-success">ðŸ“ž WhatsApp</a>
                        <a href="https://www.instagram.com/aamodapickles" class="btn btn-light" target="_blank">ðŸ“¸
                            Instagram</a>
                        <a href="mailto:aamodapickles@gmail.com" class="btn btn-warning">ðŸ“§ Email Us</a>
                        <a href="tel:7731021234" class="btn btn-primary">ðŸ“± Call: 7731021234</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer bg-warning text-center py-4">
        <p>Â© 2025 Aamoda Pickles. All rights reserved.</p>
        <div class="container mt-2">
            <a href="terms.html" class="text-red mx-2">Terms & Conditions</a> |
            <a href="shipping.html" class="text-red mx-2">Shipping Policy</a> |
            <a href="contact.html" class="text-red mx-2">Contact Us</a> |
            <a href="refundpolicy.html" class="text-red mx-2">Cancel & refund Policy</a> |
            <a href="privacypolicy.html" class="text-red mx-2">Privacy Policy</a>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="products.js"></script>
    <script src="cart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            updateCartIcon();

            const orderSummaryItemsContainer = document.getElementById('order-summary-items');
            const orderSubtotalElement = document.getElementById('order-subtotal');
            const shippingCostElement = document.getElementById('shipping-cost');
            const orderTotalElement = document.getElementById('order-total');
            const checkoutForm = document.getElementById('checkout-form');
            const zipCodeField = document.getElementById('zip');
            const cart = getCart();

            const tanukuPinCode = '534211'; // Origin pincode
            const tanukuCoordinates = { latitude: 16.7561, longitude: 81.6888 }; // Coordinates for Tanuku

            // ----  Cart Empty Handling ----
            if (cart.length === 0) {
                orderSummaryItemsContainer.innerHTML =
                    '<p class="text-center">Your cart is empty. Please add items to proceed to checkout.</p>';
                checkoutForm.style.display = 'none'; // Hide the form if cart is empty
                orderSubtotalElement.textContent = '0';
                shippingCostElement.textContent = '0';
                orderTotalElement.textContent = '0';
                return; // Stop further execution if cart is empty
            }

            let subtotal = 0;
            let totalWeight = 0; // Total weight in grams

            // ----  Order Summary Population and Initial Calculations ----
            cart.forEach(item => {
                // console.log("Cart Item:", item); // Debugging: Log the cart item
                const product = getProductById(item.id);
                // console.log("Found Product:", product); // Debugging: Log the found product

                if (!product) {
                    console.error('Product not found in products.js for ID:', item.id);
                    return; // Skip this item if product details are missing
                }

                // Ensure that product.prices and item.quantityKey are valid
                if (product.prices && product.prices[item.quantityKey]) {
                    const itemTotal = item.pricePerUnit * item.count; // Use pricePerUnit from cart item
                    subtotal += itemTotal;

                    // Assuming 'weights' property exists in your product object with keys like '250gm', '500gm', etc.
                    if (product.weights && product.weights[item.quantityKey]) {
                        totalWeight += product.weights[item.quantityKey] * item.count;
                    } else {
                        console.warn('Weight information missing for product:', product.name, 'quantity:', item.quantityKey);
                    }

                    const orderItemHtml = `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <span>${product.name} (${item.quantityKey}) x ${item.count}</span>
                            <span>â‚¹${itemTotal.toFixed(2)}</span>
                        </div>
                    `;
                    orderSummaryItemsContainer.innerHTML += orderItemHtml;
                } else {
                    console.error('Price information missing or invalid quantity key for product:', product.name, 'quantity:', item.quantityKey);
                }
            });

            orderSubtotalElement.textContent = subtotal.toFixed(2); // Display with 2 decimal places


            // ----  Distance Calculation (Placeholder - Requires Geocoding API for accuracy) ----
            function calculateDistance(zipCode) {
                // In a real application, you'd use a geocoding API (e.g., Google Maps Geocoding API)
                // to convert the user's address/pincode to coordinates for accurate distance calculation.
                // This is a simplified placeholder based on city names.
                try {
                    const userCity = document.getElementById('city').value;
                    const userState = document.getElementById('state').value; // You might use state for broader zones

                    let userCoordinates = { latitude: 0, longitude: 0 }; // Default to 0,0

                    // Very basic city-based coordinate simulation
                    if (userCity.toLowerCase().includes('hyderabad')) {
                        userCoordinates = { latitude: 17.3850, longitude: 78.4867 };
                    } else if (userCity.toLowerCase().includes('chennai')) {
                        userCoordinates = { latitude: 13.0827, longitude: 80.2707 };
                    } else if (userCity.toLowerCase().includes('bangalore')) {
                        userCoordinates = { latitude: 12.9716, longitude: 77.5946 };
                    } else if (userCity.toLowerCase().includes('tanuku') || zipCode === tanukuPinCode) {
                        userCoordinates = tanukuCoordinates; // If it's the origin city, distance is 0
                    }
                    // Add more cities/states and their approximate coordinates as needed for better simulation

                    if (userCoordinates.latitude === 0 && userCoordinates.longitude === 0) {
                        // If city not recognized, return a default distance or handle as unknown
                        // For now, let's return a large distance to ensure a shipping cost
                        return 1500; // Default large distance if city not matched
                    }

                    // geolib.getDistance returns distance in meters, convert to kilometers
                    const distance = geolib.getDistance(tanukuCoordinates, userCoordinates) / 1000;
                    return distance;

                } catch (error) {
                    console.error("Error calculating distance:", error);
                    return 0; // Return 0 or a default large distance on error
                }
            }


            // ---- Shipping Calculation based on Weight and Simulated Distance ----
            function calculateShipping() {
                let shippingRate = 0;
                const freeShippingThreshold = 2000; // Order value above which shipping is free
                const currentZipCode = zipCodeField.value; // Get current zip code from input
                const distance = calculateDistance(currentZipCode); // Get simulated distance in km

                // Convert totalWeight from grams to kilograms for easier tier comparison
                const totalWeightKg = totalWeight / 1000;

                if (subtotal >= freeShippingThreshold) {
                    shippingRate = 0; // Free shipping
                } else {
                    // Base weight-based rates (adjust these as per your courier charges)
                    if (totalWeightKg <= 0.5) { // 0-500g
                        shippingRate = 50;
                    } else if (totalWeightKg <= 1) { // 501g-1kg
                        shippingRate = 80;
                    } else if (totalWeightKg <= 2) { // 1.01kg-2kg
                        shippingRate = 120;
                    } else { // Above 2kg
                        // For every additional kg or part thereof above 2kg, add a charge
                        // Example: 120 (for first 2kg) + (additional_kg * 50)
                        shippingRate = 120 + (Math.ceil(totalWeightKg - 2) * 50);
                    }

                    // Distance-based adjustments (Simplified and illustrative)
                    // These are *additional* charges based on distance, mimicking courier zones
                    if (distance > 100 && distance <= 500) { // Regional
                        shippingRate += 30;
                    } else if (distance > 500 && distance <= 1000) { // Zonal
                        shippingRate += 60;
                    } else if (distance > 1000) { // National
                        shippingRate += 100;
                    }
                }

                // Update display
                shippingCostElement.textContent = shippingRate.toFixed(2);
                const totalAmount = subtotal + shippingRate;
                orderTotalElement.textContent = totalAmount.toFixed(2);

                return shippingRate; // Return the calculated shipping rate
            }

            // ----  Initial Calculations & Event Listeners for Dynamic Update ----
            // Initial calculation when the page loads
            calculateShipping();

            // Recalculate shipping and total when relevant fields change
            zipCodeField.addEventListener('input', calculateShipping); // Use 'input' for real-time updates
            document.getElementById('city').addEventListener('input', calculateShipping);
            document.getElementById('state').addEventListener('input', calculateShipping);


            // ----  Razorpay Integration ----
            checkoutForm.addEventListener('submit', function (e) {
                e.preventDefault(); // Prevent default form submission

                // Get form data
                const fullName = document.getElementById('fullName').value;
                const email = document.getElementById('email').value;
                const phone = document.getElementById('phone').value;
                const address = document.getElementById('address').value;
                const city = document.getElementById('city').value;
                const state = document.getElementById('state').value;
                const zipCode = document.getElementById('zip').value;
                const country = document.getElementById('country').value;

                // Recalculate shipping just before payment to ensure latest values
                const currentShippingCost = calculateShipping(); // This also updates the displayed total
                const totalAmountPayable = parseFloat(orderTotalElement.textContent); // Get parsed total from display

                // Razorpay Options
                const options = {
                    key: "rzp_test_dzr0ExL25Pj8II",  // Your Razorpay Test Key ID
                    amount: totalAmountPayable * 100,  // Amount in paise
                    currency: "INR",
                    name: "Aamoda Pickles",
                    description: "Order from Aamoda Pickles",
                    image: "logo.png", // Path to your logo image
                    handler: function (response) {
                        // This function is called on successful payment
                        alert("Payment Successful! Payment ID: " + response.razorpay_payment_id);
                        console.log("Payment Response:", response);

                        // In a production environment, you would send response.razorpay_payment_id,
                        // response.razorpay_order_id, and response.razorpay_signature to your backend
                        // for server-side verification to ensure payment authenticity.

                        clearCart();  // Clear the cart after successful payment
                        window.location.href = 'index.html';  // Redirect to home or a success page
                    },
                    prefill: {
                        name: fullName,
                        email: email,
                        contact: phone
                    },
                    notes: {
                        address: address,
                        city: city,
                        state: state,
                        zip: zipCode,
                        country: country,
                        shippingCost: currentShippingCost,
                        totalWeight: totalWeight / 1000 // Store in KG for notes
                    },
                    theme: {
                        color: "#400607" // Your brand color
                    }
                };

                // Handle payment failure (optional, but good for debugging)
                options.handler.onClose = function () {
                    console.log("Payment widget closed by user.");
                    // You might want to show a message or log this event
                };

                options.handler.onDismiss = function () {
                    console.log("Payment widget dismissed by user.");
                    // You might want to show a message or log this event
                };

                options.handler.onFailure = function (response) {
                    // This function is called on payment failure
                    alert("Payment Failed: " + response.error.description);
                    console.error("Payment Failure Response:", response);
                    // You might want to log this error to your server or display a more user-friendly message
                };


                const rzp1 = new Razorpay(options);
                rzp1.open();
            });
        });

    </script>
</body>

</html>
